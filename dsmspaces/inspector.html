<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PMTiles Inspector</title>
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 300px; width: 100%; }
        #info { position: absolute; bottom: 0; width: 100%; height: 300px; 
                background: #f5f5f5; padding: 20px; box-sizing: border-box;
                overflow-y: auto; }
        #info h3 { margin-top: 0; }
        .layer-list { background: white; padding: 10px; margin: 10px 0; 
                      border-radius: 4px; }
        .layer-item { padding: 5px; border-bottom: 1px solid #eee; }
        .feature-count { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info">
        <h3>PMTiles Layer Inspector</h3>
        <p>Click on the map to see available layers and features at that location.</p>
        <div id="output"></div>
    </div>

    <script>
        const protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);
        
        const map = new maplibregl.Map({
            container: "map",
            style: {
                "version": 8,
                "sources": {
                    "basemap": {
                        "type": "vector",
                        "url": "pmtiles:///tiles/desmoines.pmtiles"
                    }
                },
                "layers": [
                    {
                        "id": "landuse",
                        "type": "fill",
                        "source": "basemap",
                        "source-layer": "landuse",
                        "paint": { 
                            "fill-color": "#d8e8c8",
                            "fill-opacity": 0.3
                        }
                    },
                    {
                        "id": "water",
                        "type": "fill",
                        "source": "basemap",
                        "source-layer": "water",
                        "paint": { "fill-color": "#aadaff" }
                    },
                    {
                        "id": "building",
                        "type": "fill",
                        "source": "basemap",
                        "source-layer": "building",
                        "paint": { 
                            "fill-color": "#d9d0c9",
                            "fill-opacity": 0.7
                        }
                    },
                    {
                        "id": "transportation",
                        "type": "line",
                        "source": "basemap",
                        "source-layer": "transportation",
                        "paint": { 
                            "line-color": "#ffffff",
                            "line-width": 2
                        }
                    },
                    {
                        "id": "road",
                        "type": "line",
                        "source": "basemap",
                        "source-layer": "road",
                        "paint": { 
                            "line-color": "#ffcccc",
                            "line-width": 2
                        }
                    }
                ]
            },
            center: [-93.62, 41.59],
            zoom: 12
        });

        map.on('load', () => {
            const output = document.getElementById('output');
            output.innerHTML = '<p><strong>Map loaded. Checking available layers...</strong></p>';
            
            // Check what's actually loaded
            const style = map.getStyle();
            const sources = style.sources;
            
            let info = '<div class="layer-list"><strong>Configured Layers:</strong><br>';
            style.layers.forEach(layer => {
                info += `<div class="layer-item">${layer.id} (source-layer: ${layer['source-layer'] || 'N/A'})</div>`;
            });
            info += '</div>';
            
            output.innerHTML += info;
        });

        // Click to inspect features
        map.on('click', (e) => {
            const features = map.queryRenderedFeatures(e.point);
            const output = document.getElementById('output');
            
            if (features.length === 0) {
                output.innerHTML = '<p><strong>No features found at this location.</strong></p>' +
                    '<p>Try clicking on visible features on the map.</p>';
                return;
            }

            // Group by source layer
            const byLayer = {};
            features.forEach(f => {
                const layer = f.sourceLayer || 'unknown';
                if (!byLayer[layer]) byLayer[layer] = [];
                byLayer[layer].push(f);
            });

            let html = `<p><strong>Found ${features.length} features:</strong></p>`;
            html += '<div class="layer-list">';
            
            Object.keys(byLayer).forEach(layerName => {
                const layerFeatures = byLayer[layerName];
                html += `<div class="layer-item">`;
                html += `<strong>${layerName}</strong> `;
                html += `<span class="feature-count">(${layerFeatures.length} features)</span><br>`;
                
                // Show first feature's properties as example
                if (layerFeatures[0].properties) {
                    html += `<small>Example properties: ${JSON.stringify(layerFeatures[0].properties, null, 2)}</small>`;
                }
                html += `</div>`;
            });
            
            html += '</div>';
            output.innerHTML = html;
        });
    </script>
</body>
</html>