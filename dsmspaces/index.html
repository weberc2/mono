<!DOCTYPE html>
<html>

<head>
    <title>DSM Spaces</title>

    <!-- maplibre -->
    <script src="https://unpkg.com/maplibre-gl@^5.15.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@^5.15.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@^4.3.2/dist/pmtiles.js"></script>

    <!-- leaflet (script must follow stylesheet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
            position: relative;
            z-index: 0;
        }

        .map-shell {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .search-results {
            position: absolute;
            top: 0;
            left: 0;

            width: 360px;
            height: 100%;

            background: white;
            z-index: 10;
            /* higher than map */
            transform: translateX(-100%);
            transition: transform 150ms ease-out;
        }

        .search-results.open {
            transform: translateX(0);
        }

        .search-results__close {
            position: absolute;
            top: 8px;
            right: 8px;

            width: 32px;
            height: 32px;

            display: grid;
            place-items: center;

            border: none;
            background: transparent;
            cursor: pointer;

            font-size: 18px;
            line-height: 1;
        }

        .search-results-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .search-result {
            padding: 12px 16px;
            cursor: pointer;

            display: flex;
            flex-direction: column;
            gap: 4px;

            border-bottom: 1px solid #eee;
        }
    </style>
</head>

<body>
    <h1>DSM Spaces</h1>
    <div id="error"></div>
    <input type="text" id="query" />
    <button id="submit">Search</button>
    <div class="map-shell">
        <div id="map"></div>
        <div id="results-container" class="search-results">
            <button id="results-close" class="search-results__close"> &times; </button>
            <ol id="results-list" class="search-results-list">
            </ol>
        </div>
    </div>
    <script>
        const protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        const map = new maplibregl.Map({
            container: "map",
            center: [-93.62, 41.59],
            zoom: 12,
            pitch: 0,
            bearing: 0,
            antialias: true,
            maxBounds: [
                [-93.75, 41.48],  // Southwest corner
                [-93.45, 41.72]   // Northeast corner
            ],
            minZoom: 10,
            maxZoom: 18,
            style: {
                "version": 8,
                "sources": {
                    "basemap": {
                        "type": "vector",
                        "url": "pmtiles:///tiles/desmoines.pmtiles"
                    }
                },
                "layers": [
                    {
                        "id": "background",
                        "type": "background",
                        "paint": {
                            "background-color": "#fef9f3"
                        }
                    },
                    {
                        "id": "landuse-park",
                        "type": "fill",
                        "source": "basemap",
                        "source-layer": "landuse",
                        "filter": ["in", ["get", "class"], ["literal", ["park", "grass", "recreation_ground", "garden"]]],
                        "paint": {
                            "fill-color": "#d4edda",
                            "fill-opacity": 0.6
                        }
                    },
                    {
                        "id": "landuse-residential",
                        "type": "fill",
                        "source": "basemap",
                        "source-layer": "landuse",
                        "filter": ["==", ["get", "class"], "residential"],
                        "paint": {
                            "fill-color": "#f5e6ff",
                            "fill-opacity": 0.3
                        }
                    },
                    {
                        "id": "landuse-commercial",
                        "type": "fill",
                        "source": "basemap",
                        "source-layer": "landuse",
                        "filter": ["==", ["get", "class"], "commercial"],
                        "paint": {
                            "fill-color": "#fff3e0",
                            "fill-opacity": 0.35
                        }
                    },
                    {
                        "id": "landuse-industrial",
                        "type": "fill",
                        "source": "basemap",
                        "source-layer": "landuse",
                        "filter": ["==", ["get", "class"], "industrial"],
                        "paint": {
                            "fill-color": "#e8eaf6",
                            "fill-opacity": 0.35
                        }
                    },
                    {
                        "id": "water",
                        "type": "fill",
                        "source": "basemap",
                        "source-layer": "water",
                        "paint": {
                            "fill-color": "#c5e8ff",
                            "fill-opacity": 0.85
                        }
                    },
                    {
                        "id": "water-outline",
                        "type": "line",
                        "source": "basemap",
                        "source-layer": "water",
                        "paint": {
                            "line-color": "#a8d8f0",
                            "line-width": 1,
                            "line-opacity": 0.5
                        }
                    },
                    {
                        "id": "roads-motorway",
                        "type": "line",
                        "source": "basemap",
                        "source-layer": "transportation",
                        "filter": ["in", ["get", "class"], ["literal", ["motorway", "trunk"]]],
                        "paint": {
                            "line-color": "#ffa5a5",
                            "line-width": [
                                "interpolate",
                                ["exponential", 1.5],
                                ["zoom"],
                                8, 1.5,
                                12, 3,
                                16, 8
                            ],
                            "line-opacity": 0.9
                        }
                    },
                    {
                        "id": "roads-primary",
                        "type": "line",
                        "source": "basemap",
                        "source-layer": "transportation",
                        "filter": ["==", ["get", "class"], "primary"],
                        "paint": {
                            "line-color": "#ffcf96",
                            "line-width": [
                                "interpolate",
                                ["exponential", 1.5],
                                ["zoom"],
                                8, 1,
                                12, 2.5,
                                16, 6
                            ],
                            "line-opacity": 0.85
                        }
                    },
                    {
                        "id": "roads-secondary",
                        "type": "line",
                        "source": "basemap",
                        "source-layer": "transportation",
                        "filter": ["==", ["get", "class"], "secondary"],
                        "paint": {
                            "line-color": "#ffeaa7",
                            "line-width": [
                                "interpolate",
                                ["exponential", 1.5],
                                ["zoom"],
                                10, 0.8,
                                14, 2,
                                16, 5
                            ],
                            "line-opacity": 0.8
                        }
                    },
                    {
                        "id": "roads-minor",
                        "type": "line",
                        "source": "basemap",
                        "source-layer": "transportation",
                        "paint": {
                            "line-color": "#e8e4df",
                            "line-width": [
                                "interpolate",
                                ["exponential", 1.5],
                                ["zoom"],
                                12, 0.5,
                                14, 1,
                                16, 3
                            ],
                            "line-opacity": 0.7
                        }
                    },
                    {
                        "id": "building",
                        "type": "fill",
                        "source": "basemap",
                        "source-layer": "building",
                        "minzoom": 13,
                        "paint": {
                            "fill-color": "#ffe5d9",
                            "fill-opacity": [
                                "interpolate",
                                ["linear"],
                                ["zoom"],
                                13, 0.3,
                                15, 0.7,
                                17, 0.85
                            ]
                        }
                    },
                    {
                        "id": "building-outline",
                        "type": "line",
                        "source": "basemap",
                        "source-layer": "building",
                        "minzoom": 15,
                        "paint": {
                            "line-color": "#d4bfaa",
                            "line-width": 0.5,
                            "line-opacity": 0.4
                        }
                    },
                    {
                        "id": "road-label",
                        "type": "symbol",
                        "source": "basemap",
                        "source-layer": "transportation_name",
                        "minzoom": 13,
                        "layout": {
                            "text-field": ["get", "name"],
                            "text-font": ["Open Sans Regular"],
                            "text-size": [
                                "interpolate",
                                ["linear"],
                                ["zoom"],
                                13, 10,
                                16, 13
                            ],
                            "symbol-placement": "line",
                            "text-rotation-alignment": "map",
                            "text-pitch-alignment": "viewport"
                        },
                        "paint": {
                            "text-color": "#5a5a5a",
                            "text-halo-color": "#ffffff",
                            "text-halo-width": 2,
                            "text-halo-blur": 1
                        }
                    },
                    {
                        "id": "place-neighborhood",
                        "type": "symbol",
                        "source": "basemap",
                        "source-layer": "place",
                        "filter": ["==", ["get", "class"], "neighbourhood"],
                        "layout": {
                            "text-field": ["get", "name"],
                            "text-font": ["Open Sans Regular"],
                            "text-size": 14,
                            "text-transform": "uppercase",
                            "text-letter-spacing": 0.1
                        },
                        "paint": {
                            "text-color": "#8b7fa8",
                            "text-halo-color": "#ffffff",
                            "text-halo-width": 2,
                            "text-opacity": 0.8
                        }
                    },
                    {
                        "id": "place-city",
                        "type": "symbol",
                        "source": "basemap",
                        "source-layer": "place",
                        "filter": ["in", ["get", "class"], ["literal", ["city", "town", "village"]]],
                        "layout": {
                            "text-field": ["get", "name"],
                            "text-font": ["Open Sans Bold"],
                            "text-size": 18
                        },
                        "paint": {
                            "text-color": "#2d3748",
                            "text-halo-color": "#ffffff",
                            "text-halo-width": 2.5
                        }
                    }
                ]
            },
        });

        map.addControl(new maplibregl.NavigationControl(), 'top-left');

        console.log("map initialized");
    </script>
    <script>
        const body = document.querySelector("body");
        const errorElt = document.getElementById("error");
        const queryElt = document.getElementById("query");
        const resultsElt = document.getElementById("results-list");
        const resultsContainerElt = document.getElementById("results-container");
        const resultsCloseElt = document.getElementById("results-close");
        const submitElt = document.getElementById("submit");

        resultsCloseElt.onclick = () => resultsContainerElt.classList.remove("open");

        var markers = [];
        submitElt.onclick = async () => {
            try {
                resultsContainerElt.classList.add("open");
                const rsp = await fetch(
                    "/search?" + (new URLSearchParams({ q: queryElt.value })).toString(),
                );
                if (rsp.status === 200) {
                    const results = await rsp.json();
                    // Remove old markers
                    markers.forEach(marker => marker.remove());

                    markers = [];
                    resultsElt.replaceChildren();

                    // Add new markers and search results
                    for (const result of results) {
                        const marker = new maplibregl.Marker()
                            .setLngLat([
                                result.place.location.coordinates.longitude,
                                result.place.location.coordinates.latitude
                            ])
                            .setPopup(
                                new maplibregl.Popup({ offset: 25 })
                                    .setHTML(`<b>${result.place.name}</b><br>${result.place.description || ""}`)
                            )
                            .addTo(map);
                        markers.push(marker);

                        const elt = document.createElement("li");
                        elt.classList.add("search-result");
                        elt.textContent = `${result.place.name}: ${result.score}`;
                        elt.onclick = () => {
                            map.flyTo({
                                center: [
                                    result.place.location.coordinates.longitude,
                                    result.place.location.coordinates.latitude
                                ],
                                zoom: 15,
                                essential: true
                            });
                            markers.forEach(m => m.getPopup().remove());
                            marker.togglePopup();
                        };
                        resultsElt.appendChild(elt);
                    }
                } else {
                    errorElt = await rsp.text();
                }
            } catch (e) {
                errorElt.textContent = e;
            }
        };
    </script>
</body>

</html>