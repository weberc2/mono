<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Status</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <h1>Server Status</h1>
        <div id="loading" class="loading">Loading pods...</div>
        <div id="nodes" class="nodes"></div>
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        async function loadPods() {
            try {
                const loadingEl = document.getElementById('loading');
                const nodesEl = document.getElementById('nodes');
                const errorEl = document.getElementById('error');

                const response = await fetch('/pods/');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                loadingEl.style.display = 'none';

                // Sort nodes by pod count (descending), then by name (ascending)
                const sortedNodes = Object.keys(data).sort((a, b) => {
                    const countDiff = data[b].length - data[a].length;
                    if (countDiff !== 0) return countDiff;
                    return a.localeCompare(b);
                });

                nodesEl.replaceChildren(sortedNodes.map(nodeName => {
                    const pods = data[nodeName];
                    const nodeEl = document.createElement('div');
                    nodeEl.className = 'node';

                    const headerEl = document.createElement('div');
                    headerEl.className = 'node-header';

                    const toggleEl = document.createElement('span');
                    toggleEl.className = 'toggle';
                    toggleEl.textContent = '▶';

                    const nameEl = document.createElement('span');
                    nameEl.className = 'node-name';
                    nameEl.textContent = nodeName;

                    const countEl = document.createElement('span');
                    countEl.className = 'pod-count';
                    countEl.textContent = `${pods.length} pod${pods.length !== 1 ? 's' : ''}`;

                    headerEl.replaceChildren(toggleEl, nameEl, countEl);

                    const podsEl = document.createElement('div');
                    podsEl.className = 'pods hidden';
                    podsEl.replaceChildren(...pods.map(pod => {
                        const div = document.createElement("div");
                        div.className = "pod";

                        const namespace = document.createElement("span");
                        namespace.className = "namespace";

                        const name = document.createElement("span");
                        name.className = "pod-name";

                        div.replaceChildren(namespace, name);
                        return div;
                    }));

                    nodeEl.appendChild(headerEl);
                    nodeEl.appendChild(podsEl);

                    headerEl.addEventListener('click', () => {
                        podsEl.classList.toggle('hidden');
                        const toggle = headerEl.querySelector('.toggle');
                        toggle.textContent = podsEl.classList.contains('hidden') ? '▶' : '▼';
                    });

                    return nodeEl;
                }));

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                const errorEl = document.getElementById('error');
                errorEl.style.display = 'block';
                errorEl.textContent = `Error loading pods: ${error.message}`;
                console.error('Error:', error);
            }
        }

        // Load pods when page loads
        document.addEventListener('DOMContentLoaded', loadPods);

        // Refresh every 30 seconds
        setInterval(loadPods, 30000);
    </script>
</body>

</html>