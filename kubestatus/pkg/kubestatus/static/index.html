<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KubeStatus</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <h1>KubeStatus</h1>
        <div id="loading" class="loading">Loading pods...</div>
        <div id="nodes" class="nodes"></div>
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        const nodes = new Map();
        async function loadPods() {
            try {
                const response = await fetch('/pods/');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                loadingEl.style.display = 'none';

                const loadingEl = document.getElementById('loading');
                const nodesEl = document.getElementById('nodes');
                const errorEl = document.getElementById('error');

                // sync nodes with data
                nodes.forEach(node => {
                    if (!(node in data)) {
                        nodes.delete(node);
                    }
                });
                Object.keys(data).forEach(node => {
                    // if a node does not have a corresponding element, create
                    // one and add it to the node map.
                    if (!nodes.has(node)) {
                        const pods = data[node].sort(
                            (a, b) => {
                                const cmp = a.namespace.localeCompare(b.namespace);
                                if (cmp === 0) {
                                    return a.name.localeCompare(b.name);
                                }
                                return cmp;
                            },
                        );
                        const nodeEl = document.createElement('div');
                        nodeEl.className = 'node';

                        const headerEl = document.createElement('div');
                        headerEl.className = 'node-header';

                        const toggleEl = document.createElement('span');
                        toggleEl.className = 'toggle';
                        toggleEl.textContent = '▶';

                        const nameEl = document.createElement('span');
                        nameEl.className = 'node-name';
                        nameEl.textContent = node;

                        const countEl = document.createElement('span');
                        countEl.className = 'pod-count';
                        countEl.textContent = `${pods.length} pod${pods.length !== 1 ? 's' : ''}`;

                        headerEl.replaceChildren(toggleEl, nameEl, countEl);

                        const podsEl = document.createElement('div');

                        podsEl.className = 'pods hidden';
                        podsEl.replaceChildren(...pods.map(pod => {
                            const div = document.createElement("div");
                            div.className = "pod";

                            const namespace = document.createElement("span");
                            namespace.className = "namespace";
                            namespace.textContent = pod.namespace;

                            const name = document.createElement("span");
                            name.className = "pod-name";
                            name.textContent = pod.name;

                            div.replaceChildren(namespace, name);
                            return div;
                        }));

                        nodeEl.appendChild(headerEl);
                        nodeEl.appendChild(podsEl);

                        headerEl.addEventListener('click', () => {
                            podsEl.classList.toggle('hidden');
                            const toggle = headerEl.querySelector('.toggle');
                            toggle.textContent = podsEl.classList.contains('hidden') ? '▶' : '▼';
                        });
                        nodes.set(node, nodeEl);
                    }
                });

                // update the DOM based on the values in the node map, sorting
                // them for stability
                const sorted = Object.keys(data).sort(
                    (a, b) => {
                        const countDiff = data[b].length - data[a].length;
                        if (countDiff !== 0) return countDiff;
                        return a.localeCompare(b);
                    }
                );
                nodesEl.replaceChildren(...sorted.map(node => nodes.get(node)));
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                const errorEl = document.getElementById('error');
                errorEl.style.display = 'block';
                errorEl.textContent = `Error loading pods: ${error.message}`;
                console.error('Error:', error);
            }
        }

        // Load pods when page loads
        document.addEventListener('DOMContentLoaded', loadPods);

        // Refresh every 30 seconds
        setInterval(loadPods, 30000);
    </script>
</body>

</html>